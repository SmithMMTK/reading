

การรักษาความปลอดภัยและการตรวจสอบเป็นสิ่งสำคัญในการบริหารจัดการ _data warehouse_

## Security

การรักษาความปลอดภัยของ _data warehouse_ มีความสำคัญเพื่อป้องกันข้อมูลจากการเข้าถึงโดยไม่ได้รับอนุญาต Fabric มีฟีเจอร์ด้านความปลอดภัยหลากหลายเพื่อช่วยให้คุณปกป้อง _data warehouse_ ของคุณ ได้แก่:

- การควบคุมการเข้าถึงตามบทบาท (_Role-based access control - RBAC_) เพื่อควบคุมการเข้าถึง _warehouse_ และข้อมูลภายใน
- การเข้ารหัสแบบ _TLS_ เพื่อปกป้องการสื่อสารระหว่าง _warehouse_ และแอปพลิเคชันฝั่งผู้ใช้งาน
- การเข้ารหัสโดย _Azure Storage Service Encryption_ เพื่อป้องกันข้อมูลทั้งขณะส่งและขณะเก็บ
- การใช้งาน _Azure Monitor_ และ _Azure Log Analytics_ เพื่อตรวจสอบกิจกรรมและการเข้าถึงข้อมูลใน _warehouse_
- การยืนยันตัวตนแบบหลายปัจจัย (_MFA_) เพื่อเพิ่มความปลอดภัยให้กับบัญชีผู้ใช้งาน
- การเชื่อมต่อกับ _Microsoft Entra ID_ เพื่อบริหารจัดการตัวตนและการเข้าถึง _warehouse_

### Workspace permissions

ข้อมูลใน Fabric จะถูกจัดการผ่าน _workspaces_ ซึ่งใช้ควบคุมการเข้าถึงและการจัดการวงจรชีวิตของข้อมูลและบริการต่าง ๆ โดยบทบาทของ _workspace_ ถือเป็นแนวป้องกันแรกในการรักษาความปลอดภัยให้กับ _data warehouse_

นอกจากบทบาทของ _workspace_ แล้ว คุณยังสามารถกำหนด _item permissions_ และการเข้าถึงผ่าน SQL ได้เพิ่มเติม

_Tip_  
ดูเพิ่มเติมที่ [Workspaces in Power BI](https://learn.microsoft.com/en-us/power-bi/collaborate-share/service-new-workspaces#roles-and-licenses)

### Item permissions

แตกต่างจาก _workspace roles_ ซึ่งมีผลกับทุกวัตถุภายใน _workspace_ การใช้ _item permissions_ จะช่วยให้คุณสามารถให้สิทธิ์เฉพาะเจาะจงกับ _warehouse_ แต่ละตัวได้ เหมาะสำหรับกรณีที่ต้องการแชร์ _data warehouse_ เพื่อนำไปใช้ต่อแบบเจาะจง

คุณสามารถให้สิทธิ์ผู้ใช้งานผ่าน T-SQL หรือผ่านพอร์ทัลของ Fabric โดยกำหนดสิทธิ์ต่อไปนี้:

- Read: อนุญาตให้ผู้ใช้เชื่อมต่อผ่าน SQL connection string
- ReadData: อนุญาตให้อ่านข้อมูลจาก _table/view_ ใด ๆ ใน _warehouse_
- ReadAll: อนุญาตให้อ่านไฟล์ _parquet_ ที่จัดเก็บใน _OneLake_ ซึ่งใช้กับ Spark

การเชื่อมต่อผ่าน SQL analytics endpoint จะล้มเหลวหากไม่มีสิทธิ์ Read อย่างน้อยที่สุด

## Monitoring

การตรวจสอบกิจกรรมใน _data warehouse_ มีความสำคัญเพื่อรักษาประสิทธิภาพ การใช้ทรัพยากรอย่างคุ้มค่า และความปลอดภัย คุณจะสามารถตรวจพบปัญหา ความผิดปกติ และดำเนินการได้ทันท่วงที

สามารถใช้ _dynamic management views_ (DMVs) เพื่อตรวจสอบสถานะของการเชื่อมต่อ, session และ request แบบเรียลไทม์ รวมถึงวิเคราะห์วงจรการทำงานของคำสั่ง SQL ได้ โดย DMV จะให้ข้อมูล เช่น จำนวนคำสั่งที่กำลังรัน และคำสั่งใดที่ใช้เวลานานเกินไปซึ่งอาจต้องหยุด

Fabric รองรับ DMV อยู่ 3 ตัว:

- `sys.dm_exec_connections`: แสดงข้อมูลของการเชื่อมต่อแต่ละรายการระหว่าง _warehouse_ กับ _engine_
- `sys.dm_exec_sessions`: แสดงข้อมูลของแต่ละ session ที่ผ่านการตรวจสอบตัวตน
- `sys.dm_exec_requests`: แสดงข้อมูลของแต่ละคำสั่งที่กำลังดำเนินการใน session

### Query monitoring

ใช้ `sys.dm_exec_requests` เพื่อระบุคำสั่งที่ใช้เวลานาน ซึ่งอาจกระทบต่อประสิทธิภาพของระบบ และดำเนินการเพื่อปรับปรุงหรือยกเลิกคำสั่งเหล่านั้น

เริ่มต้นด้วยการระบุคำสั่งที่รันนานที่สุด โดยใช้คำสั่งนี้:

```sql
SELECT request_id, session_id, start_time, total_elapsed_time
FROM sys.dm_exec_requests
WHERE status = 'running'
ORDER BY total_elapsed_time DESC;
````

จากนั้น ตรวจสอบว่าใครเป็นผู้รัน session นั้น โดยใช้:

```sql
SELECT login_name
FROM sys.dm_exec_sessions
WHERE session_id = 'SESSION_ID WITH LONG-RUNNING QUERY';
```

สุดท้าย ใช้คำสั่ง KILL เพื่อยุติ session ดังกล่าว:

```sql
KILL 'SESSION_ID WITH LONG-RUNNING QUERY';
```

_Important_

คุณต้องมีสิทธิ์เป็น Admin ของ workspace จึงจะสามารถใช้คำสั่ง KILL ได้ Admin สามารถเข้าถึง DMV ทั้ง 3 รายการได้ ขณะที่ Member, Contributor และ Viewer จะสามารถดูผลลัพธ์ของตนเองเท่านั้น และไม่สามารถดูผลลัพธ์ของผู้ใช้งานรายอื่นได้
