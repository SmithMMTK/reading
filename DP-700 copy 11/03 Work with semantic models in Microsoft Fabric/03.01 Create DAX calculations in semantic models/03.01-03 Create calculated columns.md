
บางครั้งคุณอาจต้องการ _คอลัมน์_ เพิ่มเติมจากที่มีอยู่ในข้อมูลต้นทาง โดยทั่วไปแล้ว ควรเพิ่มคอลัมน์เหล่านี้ที่ _data source_ โดยตรง ซึ่งจะช่วยให้การดูแลรักษาทำได้ง่ายขึ้น และสามารถใช้ _column logic_ ซ้ำในโมเดลหรือรายงานอื่นได้

อย่างไรก็ตาม หากคุณต้องการเพิ่มคอลัมน์หลังจากเชื่อมต่อข้อมูลใน _Power BI_ แล้ว คุณสามารถสร้าง _custom column_ ได้ใน _Power Query Editor_ หรือเพิ่ม _calculated column_ เข้าไปใน _semantic model_ ไม่ว่าจะใช้วิธีใด ผู้ใช้งานรายงานก็จะเห็นผลลัพธ์เหมือนกัน

โดยทั่วไปแล้ว นิยมใช้ _custom column_ ใน _Power Query_ มากกว่า เพราะจะถูกโหลดเข้า _model_ อย่างกะทัดรัดและมีประสิทธิภาพ ส่วน _calculated column_ ควรใช้เมื่อคุณต้องการเพิ่มคอลัมน์ให้กับ _calculated table_ หรือเมื่อสูตรนั้น:

- ขึ้นอยู่กับข้อมูลที่ผ่านการสรุปมาแล้ว (_summarized model data_)  
- ต้องใช้ฟังก์ชันเฉพาะทางของ _DAX_ เช่น _RELATED_, _RELATEDTABLE_ หรือฟังก์ชันสำหรับ _parent-child hierarchies_

## Create calculated columns

คุณสามารถใช้สูตร _DAX_ เพื่อเพิ่ม _calculated column_ ให้กับตารางใดก็ได้ในโมเดล โดยสูตรจะต้องคืนค่าแบบสเกลาร์ (_scalar_) หรือค่าหนึ่งค่า ต่อหนึ่งแถวเท่านั้น

การใช้ _calculated columns_ ใน _import models_ จะเพิ่มขนาดของพื้นที่จัดเก็บ และอาจทำให้ระยะเวลาในการรีเฟรชข้อมูลยาวนานขึ้น โดยเฉพาะเมื่อคอลัมน์นั้นขึ้นอยู่กับตารางอื่นที่ต้องถูกรีเฟรชด้วย ดังนั้นควรใช้อย่างระมัดระวัง และพิจารณาว่าจะสามารถใช้ _measure_ แทนได้หรือไม่

ตัวอย่างต่อไปนี้เป็นการสร้าง _calculated columns_ หลายรายการเพื่อรองรับการวิเคราะห์ทางการเงิน (_fiscal analysis_) ซึ่งแสดงให้เห็นถึงความยืดหยุ่นของ _calculated columns_

### Fiscal Year

คอลัมน์นี้ใช้กำหนดปีงบประมาณ (_fiscal year_) สำหรับแต่ละวันที่ โดยปีงบประมาณจะเริ่มในเดือนกรกฎาคม ดังนั้นวันที่ตั้งแต่กรกฎาคมถึงธันวาคมจะถูกนับเป็นปีถัดไปของปีปฏิทิน สูตรนี้จะรวมข้อความ `"FY"` เข้ากับค่าปี โดยเพิ่ม 1 ให้กับปีหากวันที่อยู่ในครึ่งหลังของปี

```excel
Due Fiscal Year =
"FY"
    & YEAR('Due Date'[Due Date])
        + IF(
            MONTH('Due Date'[Due Date]) > 6,
            1
        )
```

ขั้นตอนต่อไปนี้แสดงวิธีที่ _Microsoft Power BI_ ประเมินสูตรของ _calculated column_ นี้:

1. ตัวดำเนินการบวก (`+`) จะถูกประเมินก่อนตัวดำเนินการรวมข้อความ (`&`)
2. ฟังก์ชัน [`YEAR`](https://learn.microsoft.com/en-us/dax/year-function-dax/) จะคืนค่าปี (เป็นตัวเลขจำนวนเต็ม) จากวันที่ในคอลัมน์
3. ฟังก์ชัน [`IF`](https://learn.microsoft.com/en-us/dax/if-function-dax/) จะคืนค่าเมื่อหมายเลขเดือนของวันที่อยู่ระหว่าง 7-12 (กรกฎาคมถึงธันวาคม); มิฉะนั้นจะคืนค่า _BLANK_ (เช่น เพราะปีงบประมาณของ _Adventure Works_ คือตั้งแต่กรกฎาคมถึงมิถุนายน ดังนั้นครึ่งปีหลังจะใช้ปีถัดไปเป็นปีงบประมาณ)
4. ค่าปีจะถูกนำไปบวกกับค่าที่ได้จากฟังก์ชัน `IF` ซึ่งอาจเป็น 1 หรือ _BLANK_ หากเป็น _BLANK_ จะถูกแปลงเป็นศูนย์ (_0_) โดยอัตโนมัติเพื่อให้สามารถบวกได้อย่างถูกต้อง
5. ข้อความ `"FY"` จะถูกรวมเข้ากับค่าปีงบประมาณ ซึ่งจะถูกแปลงเป็นข้อความโดยอัตโนมัติ

### Fiscal Quarter

คอลัมน์นี้จะกำหนด _fiscal quarter_ ให้กับแต่ละวันที่ โดยอิงตามโครงสร้างปีงบประมาณที่ _Quarter 1_ คือช่วงเดือนกรกฎาคมถึงกันยายน สูตรนี้จะต่อท้ายตัวอักษร "Q" และหมายเลขไตรมาสเข้ากับป้ายชื่อปีงบประมาณ (_fiscal year label_)

```excel
Due Fiscal Quarter =
'Due Date'[Due Fiscal Year] & " Q"
    & IF(
        MONTH('Due Date'[Due Date]) <= 3,
        3,
        IF(
            MONTH('Due Date'[Due Date]) <= 6,
            4,
            IF(
                MONTH('Due Date'[Due Date]) <= 9,
                1,
                2
            )
        )
    )
```

### Month Key

สูตร _MonthKey_ จะนำค่าปีของวันที่กำหนด (_due date_) คูณด้วย 100 แล้วบวกด้วยหมายเลขของเดือนจากวันที่นั้น ผลลัพธ์ที่ได้จะเป็นค่าตัวเลขที่สามารถใช้จัดเรียงค่าข้อความใน _Due Month_ ตามลำดับเวลาได้อย่างถูกต้อง

```excel
MonthKey =
(YEAR('Due Date'[Due Date]) * 100) + MONTH('Due Date'[Due Date])
```

### Full Date Label

ฟังก์ชัน [`FORMAT`](https://learn.microsoft.com/en-us/dax/format-function-dax/) จะทำการแปลงค่าจากคอลัมน์ `Due Date` ให้อยู่ในรูปแบบข้อความ โดยใช้รูปแบบที่กำหนด (_format string_) ในกรณีนี้ รูปแบบที่ใช้จะสร้างป้ายข้อความที่แสดงปี ชื่อเดือนแบบย่อ และวันที่

```excel
Due Full Date =
FORMAT('Due Date'[Due Date], "yyyy mmm, dd")
```

 > **Note**  มีรูปแบบการกำหนดวันที่และเวลา (_date/time formats_) ที่ผู้ใช้สามารถกำหนดเองได้หลากหลาย ดูข้อมูลเพิ่มเติมได้ที่ [Custom date and time formats for the FORMAT function](https://learn.microsoft.com/en-us/dax/custom-date-and-time-formats-for-the-format-function/)

หลังจากเพิ่มคอลัมน์ต่าง ๆ แล้ว ตาราง `Due Date` จะมีทั้งหมด 6 คอลัมน์ ประกอบด้วยคอลัมน์วันที่เดิม และ _calculated columns_ อีก 5 คอลัมน์ ซึ่งช่วยรองรับทั้งฟังก์ชันด้าน _time intelligence_ และเพิ่มความชัดเจนให้กับผู้ใช้รายงาน

[![Screenshot shows the Due Date table is data view. There are six columns, and the first seven rows are visible.](https://learn.microsoft.com/en-us/training/modules/dax-power-bi-create-calculations/media/dax-due-date-table-data-view-2.png)](https://learn.microsoft.com/en-us/training/modules/dax-power-bi-create-calculations/media/dax-due-date-table-data-view-2.png#lightbox#lightbox)


## Understand row context

_Power BI_ จะประเมินสูตรของ _calculated column_ สำหรับแต่ละแถวในตาราง ซึ่งเรียกว่า _row context_ โดย _row context_ หมายถึง "แถวปัจจุบัน" นั่นเอง ตัวอย่างเช่น คอลัมน์ `Due Fiscal Year` ด้านล่างนี้:

```excel
Due Fiscal Year =
"FY"
    & YEAR('Due Date'[Due Date])
        + IF(
            MONTH('Due Date'[Due Date]) <= 6,
            1
        )
```

เมื่อ _Power BI_ ประมวลผลสูตรนี้ `’Due Date’[Due Date]` จะคืนค่าจากแถวปัจจุบัน ถ้าคุณเคยใช้ _Excel tables_ มาก่อน คุณอาจคุ้นเคยกับแนวคิดนี้

_row context_ จะใช้กับตารางปัจจุบันเท่านั้น ถ้าคุณต้องการดึงค่าจากตารางอื่น มี 2 ทางเลือกหลัก:

- ถ้ามีความสัมพันธ์ระหว่างสองตาราง ให้ใช้ฟังก์ชัน [`RELATED`](https://learn.microsoft.com/en-us/dax/related-function-dax/) หรือ [`RELATEDTABLE`](https://learn.microsoft.com/en-us/dax/relatedtable-function-dax/) โดย `RELATED` ใช้ดึงค่าจากด้าน one-side ของความสัมพันธ์ ส่วน `RELATEDTABLE` จะคืนค่าเป็นตารางจากด้าน many-side
- ถ้าไม่มีความสัมพันธ์ ให้ใช้ฟังก์ชัน [`LOOKUPVALUE`](https://learn.microsoft.com/en-us/dax/lookupvalue-function-dax/)

ควรพยายามใช้ `RELATED` เมื่อสามารถทำได้ เพราะโดยทั่วไปจะเร็วกว่า `LOOKUPVALUE` เนื่องจากโครงสร้างการจัดเก็บและจัดทำดัชนีของ _Power BI_

ตัวอย่างต่อไปนี้เป็นสูตรที่เพิ่มคอลัมน์ `Discount Amount` ให้กับตาราง `Sales`:

```excel
Discount Amount =
(
    Sales[Order Quantity]
        * RELATED('Product'[List Price])
) - Sales[Sales Amount]
```

_Power BI_ จะคำนวณสูตรนี้สำหรับแต่ละแถวในตาราง `Sales` โดยจะดึง `Order Quantity` และ `Sales Amount` จากแถวปัจจุบัน ส่วน `List Price` จากตาราง `Product` จะถูกดึงโดยใช้ฟังก์ชัน `RELATED` เพื่อหาค่าที่ตรงกับแต่ละรายการขาย

_row context_ จะถูกใช้เสมอเมื่อ _Power BI_ ประเมินสูตรของ _calculated column_ และยังเกี่ยวข้องกับฟังก์ชันแบบ _iterator_ ที่ช่วยให้สร้างการสรุปผลขั้นสูงได้ ซึ่งคุณจะได้เรียนรู้เกี่ยวกับ _iterator functions_ ในหัวข้อถัดไปของโมดูลนี้

