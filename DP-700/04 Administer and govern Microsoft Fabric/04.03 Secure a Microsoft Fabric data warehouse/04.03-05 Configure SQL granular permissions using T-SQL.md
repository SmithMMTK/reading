
หากคุณคุ้นเคยกับ _relational database_ และ _enterprise warehouse_ จะทราบกันดีว่า มีสิทธิ์พื้นฐาน 4 อย่างที่ควบคุมการทำงานของ _Data Manipulation Language (DML)_ ได้แก่ `SELECT`, `INSERT`, `UPDATE`, และ `DELETE` ซึ่งใช้ได้กับทุกแพลตฟอร์มฐานข้อมูล

สิทธิ์เหล่านี้สามารถกำหนดได้ทั้งบน _tables_ และ _views_ โดยใช้คำสั่ง `GRANT`, `REVOKE`, และ `DENY`:
- หากให้สิทธิ์ด้วย `GRANT` ผู้ใช้หรือ role ที่ระบุจะได้รับสิทธิ์นั้น
- หากใช้ `DENY` ผู้ใช้นั้นจะถูกปฏิเสธสิทธิ์
- กรณีที่ผู้ใช้ได้รับทั้ง `GRANT` และ `DENY` สำหรับสิทธิ์เดียวกัน ระบบจะถือ `DENY` เป็นหลัก → _ผู้ใช้งานจะถูกปฏิเสธสิทธิ์_

## Table and view permissions

_Tables_ และ _views_ คือ object ที่สามารถกำหนดสิทธิ์การเข้าถึงได้ โดยสามารถกำหนดสิทธิ์เพิ่มเติมแบบเจาะจงลงไปในระดับคอลัมน์ได้เช่นกัน

| สิทธิ์ | คำอธิบาย |
|--------|-----------|
| `SELECT` | อนุญาตให้ผู้ใช้ดูข้อมูลภายใน object (table หรือ view) หากถูก `DENY` จะไม่สามารถดูข้อมูลได้ |
| `INSERT` | อนุญาตให้ผู้ใช้แทรกข้อมูลลงใน object หากถูก `DENY` จะไม่สามารถแทรกข้อมูลได้ |
| `UPDATE` | อนุญาตให้ผู้ใช้แก้ไขข้อมูลภายใน object หากถูก `DENY` จะไม่สามารถอัปเดตข้อมูลได้ |
| `DELETE` | อนุญาตให้ผู้ใช้ลบข้อมูลจาก object หากถูก `DENY` จะไม่สามารถลบข้อมูลได้ |

## Function and stored procedure permissions

ฟังก์ชันและ _stored procedures_ ก็สามารถกำหนดสิทธิ์ได้เช่นเดียวกัน โดยมีสิทธิ์ที่ใช้บ่อย ได้แก่:

| สิทธิ์ | คำอธิบาย |
|--------|-----------|
| `ALTER` | อนุญาตให้ผู้ใช้เปลี่ยนแปลงโครงสร้างหรือคำจำกัดความของ object |
| `CONTROL` | อนุญาตให้ผู้ใช้มีสิทธิ์ทั้งหมดบน object นั้น |

## Principle of least privilege

แนวคิดของ _principle of least privilege_ คือ:
> ให้สิทธิ์แก่ผู้ใช้หรือแอปพลิเคชันเท่าที่จำเป็นสำหรับการทำงานเท่านั้น

ตัวอย่างเช่น:
หากแอปพลิเคชันดึงข้อมูลทั้งหมดผ่าน _stored procedures_ ก็ควรให้สิทธิ์เฉพาะ `EXECUTE` กับ stored procedures เหล่านั้น โดยไม่ให้สิทธิ์เข้าถึงตารางโดยตรงเลย

### Dynamic SQL

_Dynamic SQL_ คือแนวคิดที่ใช้สร้างคำสั่ง _SQL_ แบบโปรแกรมมิ่ง กล่าวคือ คำสั่ง SQL ถูกสร้างขึ้นแบบไดนามิกภายใน _stored procedure_ หรือ _query_ โดยตรง แทนที่จะเขียนเป็นคำสั่งตายตัวไว้ล่วงหน้า

ตัวอย่างง่าย ๆ ของ _Dynamic SQL_ แสดงดังนี้:

```sql
CREATE PROCEDURE sp_TopTenRows @tableName NVARCHAR(128)
AS
BEGIN
    DECLARE @query NVARCHAR(MAX);
    SET @query = N'SELECT TOP 10 * FROM ' + QUOTENAME(@tableName);
    EXEC sp_executesql @query;
END;
```

ในตัวอย่างนี้ `@tableName` คือพารามิเตอร์ที่สามารถแทนด้วยชื่อตารางที่ต้องการตรวจสอบข้อมูล ฟังก์ชัน `QUOTENAME` ถูกใช้เพื่อครอบชื่อตารางอย่างปลอดภัย ป้องกันการโจมตีแบบ _SQL injection_ จากนั้นใช้ `sp_executesql` ซึ่งเป็น _stored procedure_ สำหรับรันคำสั่ง SQL ที่ถูกสร้างขึ้นแบบไดนามิก

ข้อควรระวัง ตัวอย่างนี้เป็นเพียงกรณีง่าย ๆ เท่านั้น ในงานจริงของ _data warehouse_ การใช้ _Dynamic SQL_ อาจซับซ้อนกว่านี้มาก ควรระมัดระวังเมื่อใช้งาน _dynamic SQL_ เนื่องจากเสี่ยงต่อการถูกโจมตีแบบ _SQL injection_ ทางที่ดีควรใช้เทคนิคการทำ _parameterization_ เช่น sp_executesql หรือ QUOTENAME เสมอ เพื่อทำให้ input ปลอดภัย

---

## Next unit: Exercise: Secure a warehouse in Microsoft Fabric