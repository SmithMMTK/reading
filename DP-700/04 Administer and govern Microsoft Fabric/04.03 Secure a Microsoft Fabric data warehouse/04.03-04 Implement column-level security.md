
[Column-level security (CLS)](https://learn.microsoft.com/en-us/fabric/data-warehouse/column-level-security) ช่วยให้คุณสามารถควบคุมการเข้าถึงข้อมูลในระดับคอลัมน์ เพื่อปกป้องข้อมูลที่มีความอ่อนไหว โดยให้การควบคุมในระดับละเอียด (_granular control_) ว่าใครสามารถเข้าถึงข้อมูลเฉพาะส่วนใดได้บ้าง ซึ่งช่วยเพิ่มความปลอดภัยโดยรวมของ _data warehouse_

## Secure sensitive data

ลองพิจารณาตัวอย่างของ _Column-level security (CLS)_ ในอุตสาหกรรมด้านสุขภาพ โดยมีตารางชื่อ `Patients` ซึ่งประกอบด้วยคอลัมน์ดังนี้: `PatientID`, `Name`, `Address`, `DateOfBirth` และ `MedicalHistory`

คอลัมน์ `MedicalHistory` บรรจุข้อมูลด้านสุขภาพที่มีความอ่อนไหวของผู้ป่วย ซึ่งตามข้อกำหนดของกฎหมายและข้อบังคับด้านความเป็นส่วนตัว ข้อมูลนี้ควรเข้าถึงได้เฉพาะบุคลากรทางการแพทย์ที่ได้รับอนุญาต เช่น แพทย์หรือพยาบาลเท่านั้น

วิธีการใช้ _Column-level security_ ในกรณีนี้สามารถทำได้ดังนี้:

1. **ระบุคอลัมน์ที่มีความอ่อนไหว**: ในกรณีนี้คือคอลัมน์ `MedicalHistory`
2. **กำหนดบทบาทการเข้าถึง (access roles)**: เช่น `Doctor` และ `Nurse` ซึ่งสามารถเข้าถึง `MedicalHistory` ได้ ส่วนบทบาทอื่น เช่น `Receptionist` หรือ `Patient` จะไม่สามารถเข้าถึงคอลัมน์นี้ได้
3. **กำหนดบทบาทให้กับผู้ใช้งาน**: เช่น ผู้ใช้ `DrSmith` ได้รับบทบาท `Doctor` ส่วน `JohnDoe` ได้รับบทบาท `Patient`
4. **กำหนดนโยบายการควบคุมการเข้าถึง**: จัดการให้การเข้าถึงคอลัมน์ `MedicalHistory` ถูกจำกัดตามบทบาทของผู้ใช้

การใช้ _Column-level security_ ช่วยให้มั่นใจได้ว่าข้อมูลด้านสุขภาพที่มีความอ่อนไหวจะเข้าถึงได้เฉพาะผู้ที่มีสิทธิ์เท่านั้น ซึ่งช่วยปกป้องความเป็นส่วนตัวของผู้ป่วยและสอดคล้องกับข้อกำหนดด้านกฎหมาย

## Configure column-level security

ในสถานการณ์ที่เราพูดถึงไปก่อนหน้านี้ การใช้งาน _Column-level security (CLS)_ อาจมีรูปแบบคำสั่งดังนี้:

```sql
-- Create roles
CREATE ROLE Doctor AUTHORIZATION dbo;
CREATE ROLE Nurse AUTHORIZATION dbo;
CREATE ROLE Receptionist AUTHORIZATION dbo;
CREATE ROLE Patient AUTHORIZATION dbo;
GO

-- Grant SELECT on all columns to all roles
GRANT SELECT ON dbo.Patients TO Doctor;
GRANT SELECT ON dbo.Patients TO Nurse;
GRANT SELECT ON dbo.Patients TO Receptionist;
GRANT SELECT ON dbo.Patients TO Patient;
GO

-- Deny SELECT on the MedicalHistory column to the Receptionist and Patient roles
DENY SELECT ON dbo.Patients (MedicalHistory) TO Receptionist;
DENY SELECT ON dbo.Patients (MedicalHistory) TO Patient;
GO
```

ในตัวอย่างนี้ เราจะเริ่มจากการสร้างบทบาท (_roles_) ได้แก่ `Doctor`, `Nurse`, `Receptionist` และ `Patient` จากนั้นให้สิทธิ์ `SELECT` บนทุกคอลัมน์ในตาราง `Patients` แก่ทุกบทบาท แล้วจึงใช้คำสั่ง `DENY` เพื่อปฏิเสธสิทธิ์ `SELECT` บนคอลัมน์ `MedicalHistory` สำหรับบทบาท `Receptionist` และ `Patient`

สิ่งนี้ช่วยให้มั่นใจได้ว่า เฉพาะผู้ใช้ที่มีบทบาทเป็น `Doctor` หรือ `Nurse` เท่านั้นที่สามารถเข้าถึงคอลัมน์ `MedicalHistory` ได้

## Understand the benefits

ในด้านความปลอดภัยของ _data warehouse_ มีเทคนิคที่ใช้งานกันอย่างแพร่หลายอยู่ 2 แบบ คือ _Column-level security (CLS)_ และ _Views_ ซึ่งทั้งสองวิธีต่างมีเป้าหมายเดียวกัน คือการจำกัดการเข้าถึงข้อมูลที่มีความอ่อนไหว แต่มีวิธีการดำเนินการและจุดเด่นแตกต่างกัน

ตารางด้านล่างเปรียบเทียบทั้งสองเทคนิคในด้านต่าง ๆ เช่น ความละเอียดในการควบคุมสิทธิ์, การดูแลรักษา, ประสิทธิภาพ, ความโปร่งใสในการทำงาน, และความยืดหยุ่น

ตารางนี้จะช่วยให้คุณเข้าใจข้อดีข้อเสียของแต่ละวิธี และช่วยเลือกแนวทางที่เหมาะสมกับการใช้งานของคุณ

| ด้านการเปรียบเทียบ           | Column-Level Security                                                                                     | Views                                                                                                                               |
|-------------------------------|-----------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| **ความละเอียดในการควบคุม**     | ควบคุมสิทธิ์ในระดับคอลัมน์ได้ละเอียด สามารถกำหนดสิทธิ์แตกต่างกันให้แต่ละผู้ใช้หรือบทบาทในคอลัมน์เดียวกันได้ | หากต้องการสิทธิ์ต่างกัน ต้องสร้างหลาย view เพื่อแยกการเข้าถึงแต่ละกลุ่มสิทธิ์                                                    |
| **การดูแลรักษา**              | สิทธิ์ถูกผูกกับคอลัมน์โดยตรง ทำให้เมื่อโครงสร้างตารางเปลี่ยน สิทธิ์จะยังปรับตัวตามได้อัตโนมัติ              | เมื่อโครงสร้างตารางเปลี่ยน อาจต้องแก้ไข view เพื่อให้สอดคล้องกับโครงสร้างใหม่                                                  |
| **ประสิทธิภาพ**               | โดยทั่วไปมีประสิทธิภาพดีกว่า เพราะทำงานตรงกับตารางจริง                                                  | อาจมี overhead ด้านประสิทธิภาพ โดยเฉพาะเมื่อ view มีโครงสร้างซับซ้อน หรือใช้กับตารางขนาดใหญ่                                     |
| **ความโปร่งใสในการใช้งาน**     | ผู้ใช้ยังคงใช้ตารางตามปกติ ระบบฐานข้อมูลจะจัดการเรื่องสิทธิ์ให้อย่างเบื้องหลังโดยไม่รู้สึกถึงการจำกัดสิทธิ์ | ผู้ใช้ต้อง query ผ่าน view ซึ่งเป็น object คนละตัวกับตารางจริง อาจต้องเรียนรู้ว่าใช้ view ไหน                                      |
| **ความยืดหยุ่น**              | ยืดหยุ่นน้อยกว่า view                                                                                  | ยืดหยุ่นสูง สามารถทำ security ทั้งระดับแถว (ด้วย WHERE clause) และระดับคอลัมน์ รวมถึงสามารถคำนวณหรือเปลี่ยนแปลงข้อมูลภายใน view ได้ |

> การเลือกใช้ระหว่าง Column-Level Security และ Views ขึ้นอยู่กับความต้องการเฉพาะของแอปพลิเคชัน  
> ควรทำการทดสอบการเปลี่ยนแปลงด้านความปลอดภัยในสภาพแวดล้อมทดสอบก่อนนำไปใช้ในระบบจริงเสมอ

---

## Next unit: Configure SQL granular permissions using T-SQL