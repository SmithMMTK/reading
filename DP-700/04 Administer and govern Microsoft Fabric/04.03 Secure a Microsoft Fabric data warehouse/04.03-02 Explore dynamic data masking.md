
[Dynamic Data Masking (DDM)](https://learn.microsoft.com/en-us/fabric/data-warehouse/dynamic-data-masking) เป็นฟีเจอร์ด้านความปลอดภัยที่ช่วยจำกัดการเปิดเผยข้อมูลต่อผู้ใช้ที่ไม่มีสิทธิ์ โดยการปกปิดข้อมูลที่มีความอ่อนไหว

_Dynamic data masking_ มีข้อดีหลายประการที่ช่วยเพิ่มความปลอดภัยและความสะดวกในการจัดการข้อมูล หนึ่งในข้อดีหลักคือความสามารถในการ _masking แบบเรียลไทม์_ เมื่อมีการรันคำสั่ง _query_ ที่เข้าถึงข้อมูลที่มีความอ่อนไหว ระบบจะทำการ _mask_ ข้อมูลเหล่านั้นในทันที ซึ่งหมายความว่า ข้อมูลจริงจะไม่ถูกเปิดเผยให้กับผู้ใช้ที่ไม่ได้รับอนุญาต ส่งผลให้ระดับความปลอดภัยของข้อมูลเพิ่มขึ้น

นอกจากนี้ _DDM_ ยังใช้งานได้ง่าย ไม่จำเป็นต้องเขียนโค้ดที่ซับซ้อน จึงเหมาะกับผู้ใช้งานทุกระดับ

อีกหนึ่งข้อดีของ _DDM_ คือข้อมูลจริงในฐานข้อมูลจะไม่ถูกเปลี่ยนแปลงเมื่อมีการใช้งาน _DDM_ โดย _masking rules_ จะถูกนำไปใช้กับผลลัพธ์ของ _query_ แทน ซึ่งหมายความว่า ข้อมูลจริงยังคงอยู่ในสภาพเดิมและปลอดภัย ขณะที่ผู้ใช้ที่ไม่มีสิทธิ์จะเห็นเฉพาะข้อมูลที่ถูก _mask_ แล้วเท่านั้น

## Define masking rule

_Dynamic data masking_ ซึ่งถูกตั้งค่าระดับ _column_ มีฟีเจอร์หลากหลาย เช่น ความสามารถในการ _mask_ ข้อมูลแบบครอบคลุม (_comprehensive masking_) แบบบางส่วน (_partial masking_) รวมถึงฟังก์ชัน _random masking_ ซึ่งถูกออกแบบมาสำหรับข้อมูลประเภทตัวเลขโดยเฉพาะ

| ประเภทการ Mask  | คำอธิบาย                                                                            | กรณีการใช้งาน                                                        | ข้อจำกัด                                                     | กฎการ Masking                                             |
| --------------- | ----------------------------------------------------------------------------------- | -------------------------------------------------------------------- | ------------------------------------------------------------ | --------------------------------------------------------- |
| **Default**     | การ _mask_ แบบเต็มรูปแบบตามชนิดข้อมูลของฟิลด์ที่กำหนด                               | เหมาะเมื่อคุณต้องการซ่อนข้อมูลจริงทั้งหมด                            | ข้อมูลจะถูก _mask_ ทั้งหมดโดยไม่สามารถเห็นรายละเอียดใด ๆ ได้ | `default()`                                               |
| **Email**       | แสดงเฉพาะอักษรตัวแรกของอีเมลและคำว่า ".com" ที่ต่อท้ายเป็นค่าคงที่                  | เหมาะเมื่อคุณต้องการแสดงว่าเป็นฟิลด์อีเมลโดยไม่เปิดเผยรายละเอียดจริง | ใช้ได้เฉพาะกับฟิลด์ประเภทอีเมลเท่านั้น                       | `email()`                                                 |
| **Custom Text** | แสดงเฉพาะอักขระส่วนต้นและท้ายตามจำนวนที่กำหนด พร้อมแทรกข้อความแทนตรงกลางที่กำหนดเอง | เหมาะเมื่อคุณต้องการซ่อนบางส่วนของข้อมูลจริง                         | ไม่เหมาะกับข้อมูลประเภทตัวเลข วันที่ หรือเวลา                | `partial(prefix_padding, padding_string, suffix_padding)` |
| **Random**      | แทนค่าตัวเลขหรือลำดับไบนารีใด ๆ ด้วยตัวเลขสุ่มในช่วงที่กำหนด                        | เหมาะเมื่อคุณต้องการซ่อนค่าจริงของข้อมูลตัวเลขหรือไบนารี             | ใช้ได้เฉพาะกับข้อมูลประเภทตัวเลขและไบนารีเท่านั้น            | `random(low, high)`                                       |
|                 |                                                                                     |                                                                      |                                                              |                                                           |

พารามิเตอร์ `prefix_padding` และ `suffix_padding` ในฟังก์ชัน `partial()` ใช้เพื่อระบุจำนวนอักขระที่จะแสดงจากส่วนต้นและส่วนท้ายของสตริง ส่วนพารามิเตอร์ `padding_string` ใช้สำหรับระบุข้อความที่จะแสดงแทนอักขระส่วนที่เหลือ

พารามิเตอร์ `low` และ `high` ในฟังก์ชัน `random()` ใช้เพื่อกำหนดช่วงของตัวเลขสุ่มที่จะถูกสร้างขึ้น

ประเภทการ _masking_ เหล่านี้ช่วยป้องกันการเข้าถึงข้อมูลที่มีความอ่อนไหวโดยไม่ได้รับอนุญาต โดยเปิดโอกาสให้ผู้ดูแลระบบสามารถควบคุมระดับของการเปิดเผยข้อมูลได้อย่างยืดหยุ่น โดยไม่กระทบกับเลเยอร์ของแอปพลิเคชันมากนัก

การ _mask_ จะถูกนำไปใช้กับผลลัพธ์ของ _query_ เท่านั้น ดังนั้นข้อมูลในฐานข้อมูลจริงจะไม่ถูกเปลี่ยนแปลง วิธีนี้ทำให้สามารถนำการ _mask_ ไปใช้กับหลายแอปพลิเคชันได้โดยไม่ต้องแก้ไขคำสั่ง _query_ ที่มีอยู่เดิม

### Configure data masking

ลองพิจารณาตัวอย่าง _data warehouse_ ที่เก็บข้อมูลลูกค้า โดยมีตารางชื่อ `Customer` ซึ่งประกอบด้วยฟิลด์ต่าง ๆ เช่น `CustomerName`, `Email`, `PhoneNumber` และ `CreditCardNumber`

หากต้องการนำ _data masking_ มาใช้กับคอลัมน์ `CustomerName`, `Email`, `PhoneNumber` และ `CreditCardNumber` สามารถรันคำสั่งต่อไปนี้:

```sql
-- For Email
ALTER TABLE Customers
ALTER COLUMN Email ADD MASKED WITH (FUNCTION = 'email()');

-- For PhoneNumber
ALTER TABLE Customers
ALTER COLUMN PhoneNumber ADD MASKED WITH (FUNCTION = 'partial(0,"XXX-XXX-",4)');

-- For CreditCardNumber
ALTER TABLE Customers
ALTER COLUMN CreditCardNumber ADD MASKED WITH (FUNCTION = 'partial(0,"XXXX-XXXX-XXXX-",4)');
```

## View masked results

หากไม่มีการใช้ _Dynamic Data Masking_ ผู้ใช้ที่ไม่มีสิทธิ์ (nonprivileged user) รันคำสั่ง _query_ เพื่อดึงข้อมูลลูกค้า อาจเห็นข้อมูลในลักษณะดังนี้:

```sql
CustomerName: John Doe
Email: johndoe@contoso.com
PhoneNumber: 123-456-7890
CreditCardNumber: 1234-5678-9012-3456
```

แต่เมื่อมีการใช้ _Dynamic Data Masking (DDM)_ กับฟิลด์ `Email`, `PhoneNumber` และ `CreditCardNumber` คำสั่ง _query_ เดิมจะได้ผลลัพธ์ดังนี้:

```sql
CustomerName: John Doe
Email: j*****@contoso.com
PhoneNumber: XXX-XXX-7890
CreditCardNumber: XXXX-XXXX-XXXX-3456
```

จะเห็นได้ว่า ข้อมูลที่มีความอ่อนไหวถูกซ่อนจากผู้ใช้ที่ไม่มีสิทธิ์ (nonprivileged user) ซึ่งช่วยเพิ่มความปลอดภัยให้กับข้อมูลของคุณ ตัวอย่างนี้แสดงให้เห็นหลักการพื้นฐานของการทำงานของ _Dynamic Data Masking (DDM)_ ที่ช่วยป้องกันไม่ให้ข้อมูลสำคัญถูกเปิดเผยต่อผู้ที่ไม่มีสิทธิ์เข้าถึง

> **หมายเหตุ**  
> แม้ว่าผู้ใช้ที่ไม่มีสิทธิ์จะไม่เห็นข้อมูลจริง แต่ถ้าพวกเขาสามารถรัน _query_ ได้ ก็ยังมีโอกาส _เดา_ หรือ _อนุมาน_ ข้อมูลจริงได้อยู่ เนื่องจากข้อมูลไม่ได้ถูกแปลงหรือเข้ารหัสจริงในฐานข้อมูล

ดังนั้น _DDM_ ควรถูกใช้งานเป็นส่วนหนึ่งของกลยุทธ์การรักษาความปลอดภัยข้อมูลโดยรวม ซึ่งควรรวมถึง:
- การจัดการสิทธิ์ในการเข้าถึงวัตถุ (_object-level security_) อย่างเหมาะสมด้วย _SQL granular permissions_
- การยึดหลัก _least privilege_ หรือการให้สิทธิ์เท่าที่จำเป็นเท่านั้น

---


ถ้าต้องการให้ผู้ใช้สามารถเห็น **ข้อมูลจริง** ที่ถูก _Dynamic Data Masking (DDM)_ ไว้ได้ ผู้ใช้นั้น **ต้องมีสิทธิ์ UNMASK** โดยต้องได้รับสิทธิ์ระดับ _database_ ด้วยคำสั่งต่อไปนี้:

```sql
GRANT UNMASK TO [ชื่อผู้ใช้หรือ role];
````

เมื่อมีสิทธิ์ UNMASK แล้ว ผู้ใช้จะเห็นข้อมูลจริงจาก _query_ โดยไม่ถูก _mask_ อีกต่อไป

---

### **หลักการทำงานของ DDM: mark/unmark logic**

- การ _mask_ จะถูกใช้กับผลลัพธ์ของคำสั่ง SELECT สำหรับผู้ใช้ที่ **ไม่มีสิทธิ์ UNMASK**
- ระบบจะตรวจสอบสิทธิ์ของผู้รันคำสั่ง ถ้ามี UNMASK → ข้อมูลจะถูก **แสดงจริง**
- ถ้าไม่มีสิทธิ์ → ข้อมูลที่อยู่ในคอลัมน์ที่กำหนด MASKED WITH (FUNCTION = …) จะถูก **mask ตามกฎ**

---

### **แล้ว WHERE clause ใช้งานได้หรือไม่?**

**ได้**! ระบบจะยังใช้ข้อมูลจริงในการประมวลผลเงื่อนไข WHERE เสมอ แม้ว่าข้อมูลที่แสดงผลจะถูก _mask_
#### **ตัวอย่าง:**

```
SELECT CustomerName, Email  
FROM Customer  
WHERE Email LIKE '%@contoso.com';
```

- ถึงแม้ฟิลด์ Email จะถูก mask สำหรับผู้ใช้ที่ไม่มีสิทธิ์ UNMASK ผลลัพธ์ที่แสดงจะเป็นอีเมลที่ถูก mask
- แต่เงื่อนไข LIKE '%@contoso.com' จะยังคงทำงานได้ถูกต้อง เพราะระบบใช้ **ข้อมูลจริง** ในการประเมินเงื่อนไข

---

### **สรุป**

|**หัวข้อ**|**คำอธิบาย**|
|---|---|
|วิธีดูข้อมูลจริง|ให้สิทธิ์ UNMASK แก่ผู้ใช้ด้วย GRANT UNMASK TO ...|
|การตัดสินใจ mask/unmask|ขึ้นกับสิทธิ์ของผู้ใช้ ณ เวลารันคำสั่ง SELECT|
|เงื่อนไข WHERE ใช้ข้อมูลจริง|ใช่ → เงื่อนไข WHERE จะใช้ข้อมูลจริงในการประเมิน|
