
ในฐานะ _data modeler_ คุณสามารถตั้งค่า _Row-Level Security (RLS)_ ได้โดยการสร้างหนึ่งหรือหลาย _roles_ โดยแต่ละ _role_ จะมีชื่อเฉพาะภายในโมเดล และมักประกอบด้วย _rules_ หนึ่งรายการขึ้นไป _rules_ เหล่านี้จะทำหน้าที่เป็นตัวกรองข้อมูลใน _model tables_ โดยใช้ _DAX (Data Analysis Expressions)_ เพื่อสร้างเงื่อนไขการกรอง

> **Note**  
> โดยค่าเริ่มต้น _data model_ จะไม่มีการกำหนด _roles_ ซึ่งหมายความว่าผู้ใช้ที่มีสิทธิ์เข้าถึงโมเดลจะสามารถดูข้อมูลทั้งหมดได้

> **Tip**  
> คุณสามารถสร้าง _role_ ที่ไม่มี _rules_ ได้ ซึ่งในกรณีนี้ _role_ จะสามารถเข้าถึงทุกแถวของทุกตารางในโมเดล เหมาะสำหรับผู้ดูแลระบบ (_admin user_) ที่ได้รับสิทธิ์ในการเข้าถึงข้อมูลทั้งหมด

คุณสามารถสร้าง ตรวจสอบ และจัดการ _roles_ ได้ใน _Power BI Desktop_ สำหรับโมเดลใน _Azure Analysis Services_ หรือ _SQL Server Analysis Services_ คุณสามารถใช้ _SQL Server Data Tools (SSDT)_ เพื่อจัดการ _roles_ ได้เช่นกัน

นอกจากนี้ คุณยังสามารถสร้างและจัดการ _roles_ ได้ผ่าน _SQL Server Management Studio (SSMS)_ หรือเครื่องมือของบุคคลที่สาม เช่น [Tabular Editor](https://tabulareditor.com/)

เพื่อให้เข้าใจว่า _RLS_ จำกัดการเข้าถึงข้อมูลอย่างไร คุณสามารถดูภาพเคลื่อนไหวประกอบ

![Animated diagram demonstrates how row-level security works for two users who each have access to specific country/region data.](https://learn.microsoft.com/en-us/training/wwl-data-ai/enforce-power-bi-model-security/media/introduce-row-level-security.gif)

## Apply star schema design principles

เราแนะนำให้คุณใช้หลักการออกแบบแบบ [star schema](https://learn.microsoft.com/en-us/power-bi/guidance/star-schema) เพื่อสร้างโมเดลที่ประกอบด้วย _dimension tables_ และ _fact table_ โดยทั่วไปแล้ว _Power BI_ จะถูกตั้งค่าให้บังคับใช้ _rules_ ที่กรอง _dimension tables_ ซึ่งช่วยให้ [model relationships](https://learn.microsoft.com/en-us/power-bi/transform-model/desktop-relationships-understand) สามารถส่งผ่านตัวกรองไปยัง _fact tables_ ได้อย่างมีประสิทธิภาพ

ภาพด้านล่างแสดง _model diagram_ ของ _Adventure Works sales analysis data model_ ซึ่งเป็นตัวอย่างของการออกแบบแบบ _star schema_ โดยมี _fact table_ ชื่อว่า **Sales** และตารางอื่น ๆ เป็น _dimension tables_ ที่รองรับการวิเคราะห์ _sales measures_ ตาม _date_, _sales territory_, _customer_, _reseller_, _order_, _product_, และ _salesperson_

สังเกตว่าในโมเดลมี _relationships_ เชื่อมโยงทุกตารางเข้าด้วยกัน ซึ่งความสัมพันธ์เหล่านี้จะช่วยส่งผ่านตัวกรอง (ทั้งทางตรงและทางอ้อม) ไปยังตาราง **Sales**

[![Screenshot shows a Power B I Desktop model diagram comprising the tables and relationships as described in the previous paragraph.](https://learn.microsoft.com/en-us/training/wwl-data-ai/enforce-power-bi-model-security/media/model-diagram-star-schema.png)](https://learn.microsoft.com/en-us/training/wwl-data-ai/enforce-power-bi-model-security/media/model-diagram-star-schema.png#lightbox)

โมเดลนี้รองรับตัวอย่างต่าง ๆ ที่ได้นำเสนอไว้ในหน่วยนี้

## Define rules

นิพจน์ของ _rule_ จะถูกประเมินภายใต้ _row context_ ซึ่งหมายถึงนิพจน์จะถูกประเมินทีละแถว โดยใช้ค่าคอลัมน์ของแถวนั้น ถ้านิพจน์ส่งค่ากลับมาเป็น `TRUE` ผู้ใช้จะสามารถ “เห็น” ข้อมูลในแถวนั้นได้

> **Tip**  
> หากต้องการเรียนรู้เพิ่มเติมเกี่ยวกับ _row context_ แนะนำให้ศึกษาโมดูล [Add calculated tables and columns to Power BI Desktop models](https://learn.microsoft.com/en-us/training/modules/dax-power-bi-add-calculated-tables/) ซึ่งแม้จะเน้นที่การเพิ่มการคำนวณในโมเดล แต่มีหน่วยหนึ่งที่อธิบาย _row context_ โดยเฉพาะ

คุณสามารถกำหนด _rules_ ได้ทั้งแบบ _static_ หรือ _dynamic_

### Static rules

_static rules_ ใช้ _DAX expressions_ ที่อ้างอิงค่าคงที่ (_constants_) ตัวอย่างเช่น กฎต่อไปนี้ใช้กับตาราง **Region** เพื่อจำกัดการเข้าถึงข้อมูลเฉพาะการขายในภูมิภาค _Midwest_:

```excel

'Region'[Region] = "Midwest"

```

ขั้นตอนต่อไปนี้อธิบายว่า _Power BI_ บังคับใช้ _rule_ อย่างไร:

1. กรองตาราง **Region** ทำให้เหลือแถวที่สามารถมองเห็นได้เพียงแถวเดียว (เฉพาะภูมิภาค Midwest)
2. ใช้ _model relationship_ เพื่อส่งผ่านตัวกรองจากตาราง **Region** ไปยังตาราง **State** ทำให้เหลือ 14 แถวที่มองเห็นได้ (เนื่องจากภูมิภาค Midwest ประกอบด้วย 14 รัฐ)
3. ใช้ _model relationship_ เพื่อส่งผ่านตัวกรองจากตาราง **State** ไปยังตาราง **Sales** ทำให้มีแถวที่มองเห็นได้หลายพันแถว (คือข้อมูลการขายของทุกรัฐที่อยู่ในภูมิภาค Midwest)

_static rule_ ที่ง่ายที่สุดแบบหนึ่ง คือการจำกัดการเข้าถึงแถวทั้งหมดในตาราง ตัวอย่างเช่น _rule_ ต่อไปนี้ที่ใช้กับตาราง **Sales Details** (ไม่ได้แสดงใน _model diagram_):

```excel

FALSE()

```

กฎนี้ช่วยให้มั่นใจได้ว่าผู้ใช้จะไม่สามารถเข้าถึงข้อมูลในตารางได้เลย ซึ่งอาจมีประโยชน์ในกรณีที่พนักงานขายได้รับอนุญาตให้ดูยอดขายรวม (จากตาราง **Sales**) แต่ไม่สามารถดูรายละเอียดในระดับคำสั่งซื้อได้

การกำหนด _static rules_ เป็นวิธีที่เรียบง่ายและมีประสิทธิภาพ เหมาะสำหรับกรณีที่คุณต้องสร้างกฎเพียงไม่กี่รายการ เช่น ใน Adventure Works ที่มีเพียง 6 ภูมิภาคในสหรัฐฯ อย่างไรก็ตาม ควรพิจารณาข้อเสียด้วย เช่น การตั้งค่า _static rules_ อาจใช้เวลามาก และหากมีภูมิภาคใหม่เพิ่มเข้ามา คุณต้องปรับปรุงและเผยแพร่ _dataset_ ใหม่อีกครั้ง

หากคุณต้องตั้งค่ากฎจำนวนมาก และคาดว่าจะมีกฎเพิ่มเติมในอนาคต ควรพิจารณาใช้ _dynamic rules_ แทน

### Dynamic rules

_dynamic rules_ ใช้ฟังก์ชัน _DAX_ พิเศษที่คืนค่าจากสิ่งแวดล้อม (_environmental values_) แทนที่จะเป็นค่าคงที่ (_constants_) โดยมีฟังก์ชันหลัก 3 ตัวที่สามารถคืนค่าสภาพแวดล้อมได้:

- [`USERNAME`](https://learn.microsoft.com/en-us/dax/username-function-dax) หรือ [`USERPRINCIPALNAME`](https://learn.microsoft.com/en-us/dax/userprincipalname-function-dax): คืนค่าชื่อผู้ใช้ที่เข้าสู่ระบบ _Power BI_ ในรูปแบบข้อความ
- [`CUSTOMDATA`](https://learn.microsoft.com/en-us/dax/customdata-function-dax): คืนค่า **CustomData** ที่ระบุไว้ใน _connection string_ ซึ่งมักใช้กับเครื่องมือรายงานที่ไม่ใช่ _Power BI_ เช่น _Microsoft Excel_

> **Note**  
> ฟังก์ชัน `USERNAME` จะคืนค่าผู้ใช้ในรูปแบบ `DOMAIN\username` เมื่อใช้ใน _Power BI Desktop_ แต่จะคืนค่าในรูปแบบ _User Principal Name_ (UPN) เช่น `username@adventureworks.com` เมื่อใช้ใน _Power BI service_  
> หากคุณต้องการให้ค่าที่ได้มีรูปแบบเดียวกันเสมอ ควรใช้ `USERPRINCIPALNAME` แทน

ลองพิจารณาโมเดลที่มีการออกแบบใหม่ซึ่งรวมตาราง **AppUser** (ที่ถูกซ่อนไว้) โดยแต่ละแถวในตาราง **AppUser** จะระบุชื่อผู้ใช้และภูมิภาค ซึ่งมี _model relationship_ เชื่อมต่อกับตาราง **Region** เพื่อส่งผ่านตัวกรองจาก **AppUser** ไปยัง **Region**

![Image shows a revised model diagram that now includes the AppUser table. This table has two columns: Region and User Name.](https://learn.microsoft.com/en-us/training/wwl-data-ai/enforce-power-bi-model-security/media/model-diagram-appuser-table.png)

กฎต่อไปนี้ถูกนำไปใช้กับตาราง **AppUser** เพื่อจำกัดการเข้าถึงข้อมูลให้เฉพาะภูมิภาคที่ตรงกับผู้ใช้ที่เข้าสู่ระบบ (_authenticated user_)

```excel

'AppUser'[UserName] = USERPRINCIPALNAME()

```

การกำหนด _dynamic rules_ เป็นวิธีที่เรียบง่ายและมีประสิทธิภาพเมื่อมีตารางภายในโมเดลที่เก็บค่า _username_ อยู่แล้ว วิธีนี้ช่วยให้คุณสามารถบังคับใช้ _RLS_ แบบอิงตามข้อมูล (_data-driven_) ได้อย่างมีประสิทธิภาพ

ตัวอย่างเช่น เมื่อมีการเพิ่มหรือลบพนักงานขายในตาราง **AppUser** หรือมีการเปลี่ยนภูมิภาคที่รับผิดชอบ ระบบก็จะปรับการเข้าถึงข้อมูลโดยอัตโนมัติตามกฎที่กำหนดไว้โดยไม่ต้องปรับแต่งโมเดลหรือเผยแพร่ใหม่

## Validate roles

เมื่อคุณสร้าง _roles_ แล้ว สิ่งสำคัญคือต้องทดสอบว่า _roles_ เหล่านั้นบังคับใช้ตัวกรองได้ถูกต้องหรือไม่ สำหรับ _data models_ ที่สร้างใน _Power BI Desktop_ คุณสามารถใช้ฟีเจอร์ **View as** เพื่อดูรายงานในมุมมองของ _roles_ ต่าง ๆ และสามารถจำลองการส่งค่าชื่อผู้ใช้ (_username_) ที่แตกต่างกันได้ด้วย

![Screenshot shows the Power B I Desktop Modeling ribbon. The “View as” command is highlighted.](https://learn.microsoft.com/en-us/training/wwl-data-ai/enforce-power-bi-model-security/media/power-bi-desktop-security-view.png)

## Set up role mappings

คุณต้องตั้งค่า _role mappings_ ล่วงหน้าก่อนที่ผู้ใช้จะเข้าถึงเนื้อหาใน _Power BI_ โดย _role mapping_ คือการกำหนดวัตถุด้านความปลอดภัยของ _Microsoft Entra_ ให้กับแต่ละ _role_ วัตถุความปลอดภัยนี้สามารถเป็นบัญชีผู้ใช้ (_user account_) หรือกลุ่มความปลอดภัย (_security group_)

> **Tip**  
> หากเป็นไปได้ ควรกำหนด _role_ ให้กับ _security groups_ มากกว่าการกำหนดทีละผู้ใช้ เพราะจะช่วยลดจำนวน _mappings_ และสามารถมอบหมายการจัดการสมาชิกในกลุ่มให้กับผู้ดูแลระบบเครือข่ายได้

สำหรับโมเดลที่พัฒนาใน _Power BI Desktop_ การกำหนด _role mapping_ มักทำใน _Power BI service_ ส่วนสำหรับโมเดลใน _Azure Analysis Services_ หรือ _SQL Server Analysis Services_ มักทำใน _SQL Server Management Studio (SSMS)_

ดูข้อมูลเพิ่มเติมเกี่ยวกับการตั้งค่า _RLS_ ได้ที่:

- [Row-level security (RLS) with Power BI](https://learn.microsoft.com/en-us/power-bi/enterprise/service-admin-rls)
- [Row-level security (RLS) guidance in Power BI Desktop](https://learn.microsoft.com/en-us/power-bi/guidance/rls-guidance)

## Use single sign-on (SSO) for DirectQuery sources

เมื่อ _data model_ ของคุณมีตารางแบบ _DirectQuery_ และแหล่งข้อมูลรองรับ _SSO (Single Sign-On)_ แหล่งข้อมูลนั้นสามารถบังคับใช้นโยบายสิทธิ์การเข้าถึงข้อมูลได้เอง กล่าวคือ ฐานข้อมูลจะเป็นผู้บังคับใช้ _RLS_ และ _Power BI datasets_ และ _reports_ จะเคารพนโยบายความปลอดภัยของแหล่งข้อมูลโดยอัตโนมัติ

ลองพิจารณากรณีที่ Adventure Works ใช้ _Azure SQL Database_ สำหรับระบบขาย และฐานข้อมูลนี้อยู่ใน _tenant_ เดียวกับ _Power BI_ โดยในฐานข้อมูลมีการตั้งค่า _RLS_ เพื่อควบคุมการเข้าถึงแถวในตารางต่าง ๆ

คุณสามารถสร้าง _DirectQuery model_ ที่เชื่อมต่อกับฐานข้อมูลนี้ได้โดยไม่ต้องกำหนด _roles_ ภายใน _Power BI_ แล้วเผยแพร่ไปยัง _Power BI service_ จากนั้น เมื่อคุณตั้งค่าข้อมูลประจำตัวของแหล่งข้อมูลใน _Power BI service_ ให้คุณทำการ [เปิดใช้ SSO](https://learn.microsoft.com/en-us/power-bi/connect-data/service-azure-sql-database-with-direct-connect)

เมื่อผู้ใช้เปิดรายงานใน _Power BI_ ระบบจะส่งตัวตนของผู้ใช้ไปยังแหล่งข้อมูล และแหล่งข้อมูลจะบังคับใช้ _RLS_ ตามตัวตนนั้นโดยตรง

![Screenshot shows the data source credentials window with the S O option enabled.](https://learn.microsoft.com/en-us/training/wwl-data-ai/enforce-power-bi-model-security/media/set-data-source-credentials-single-sign-on.png)

สำหรับข้อมูลเพิ่มเติมเกี่ยวกับ _Row-Level Security_ ใน _Azure SQL Database_ ดูที่ [Row-level security](https://learn.microsoft.com/en-us/sql/relational-databases/security/row-level-security)

> **Note**  
> ไม่รองรับการใช้ _calculated tables_ และ _calculated columns_ ที่อ้างอิงตาราง _DirectQuery_ จากแหล่งข้อมูลที่ใช้การตรวจสอบสิทธิ์แบบ _SSO_ ภายใน _Power BI service_

ดูข้อมูลเพิ่มเติมเกี่ยวกับแหล่งข้อมูลที่รองรับ _SSO_ ได้ที่  
[Single sign-on (SSO) for DirectQuery sources](https://learn.microsoft.com/en-us/power-bi/connect-data/power-bi-data-sources)

---

## Next unit: Restrict access to Power BI model objects