[![Screenshot shows how to use DirectQuery option to get data.](https://learn.microsoft.com/en-us/training/modules/optimize-model-power-bi/media/5-direct-query-option-getting-data-ssm.png)](https://learn.microsoft.com/en-us/training/modules/optimize-model-power-bi/media/5-direct-query-option-getting-data-ssm.png#lightbox#lightbox)

เมื่อคุณใช้ _DirectQuery storage mode_ เวลาในการตอบสนองของ _query_ จะขึ้นอยู่กับประสิทธิภาพของแหล่งข้อมูลต้นทางโดยตรง หากแหล่งข้อมูลช้า ประสบการณ์ผู้ใช้จะไม่ดี และในบางกรณี _query_ อาจหมดเวลา (_timeout_) ได้ นอกจากนี้ จำนวนผู้ใช้ที่เปิดรายงานในเวลาเดียวกันก็มีผลต่อโหลดที่ส่งไปยังแหล่งข้อมูลด้วย เช่น หากหน้า _report_ มี 20 _visuals_ และมีผู้ใช้ 10 คนเปิดพร้อมกัน จะมีการส่ง _queries_ อย่างน้อย 200 ครั้งไปยังแหล่งข้อมูล เพราะแต่ละ _visual_ จะมีการร้องขอข้อมูลอย่างน้อยหนึ่งครั้ง

ประสิทธิภาพของ _semantic model_ ไม่ได้ขึ้นอยู่กับแค่ประสิทธิภาพของแหล่งข้อมูล แต่ยังขึ้นอยู่กับปัจจัยอื่นที่ควบคุมไม่ได้ เช่น:

- _Network latency_ ที่ต่ำจะช่วยให้ดึงข้อมูลเร็วขึ้น
- ประสิทธิภาพของ _server_ ที่เก็บแหล่งข้อมูล และจำนวนงานที่ _server_ ต้องทำ เช่น มีการทำ _refresh_ ข้อมูลขณะผู้ใช้จำนวนมากเข้าถึง _server_

ดังนั้น การใช้ _DirectQuery_ จึงมีความเสี่ยงต่อคุณภาพของประสิทธิภาพของโมเดล หากต้องการปรับปรุงประสิทธิภาพ คุณต้องสามารถควบคุมหรือเข้าถึงฐานข้อมูลต้นทางได้

ดูรายละเอียดเพิ่มเติมได้ที่ [DirectQuery model guidance in Power BI Desktop](https://learn.microsoft.com/en-us/power-bi/guidance/directquery-model-guidance/)

## Implications of using DirectQuery

แม้ว่าการนำเข้าข้อมูล (_import data_) จะเป็นแนวทางปฏิบัติที่แนะนำ แต่ในบางกรณีองค์กรอาจจำเป็นต้องใช้ _DirectQuery_ เนื่องจาก:

- เหมาะสำหรับข้อมูลที่มีการเปลี่ยนแปลงบ่อยและต้องการรายงานแบบใกล้เคียง _real-time_
- สามารถรองรับข้อมูลขนาดใหญ่โดยไม่ต้อง _pre-aggregate_
- รองรับข้อกำหนดด้าน _data sovereignty_ และกฎหมาย
- สามารถใช้งานร่วมกับแหล่งข้อมูลแบบ _multidimensional_ เช่น _SAP Business Warehouse (BW)_

หากองค์กรของคุณต้องการใช้ _DirectQuery_ คุณควรเข้าใจพฤติกรรมและข้อจำกัดของมัน เพื่อสามารถปรับแต่งให้ได้ประสิทธิภาพสูงสุด

### Behavior of DirectQuery connections

เมื่อคุณเชื่อมต่อ _DirectQuery_ ใน _Power BI Desktop_ จะมีพฤติกรรมดังนี้:

- เมื่อใช้ **Get Data** จะเลือกแหล่งข้อมูล หากเป็นแบบ _relational_ จะเลือกตารางและระบบจะสร้าง _query_ เพื่อดึงข้อมูล แต่ถ้าเป็นแบบ _multidimensional_ เช่น _SAP BW_ จะเลือกได้เฉพาะแหล่งข้อมูล
- เมื่อโหลดข้อมูล จะไม่มีการนำเข้าข้อมูลมาใน _Power BI Desktop_ มีเพียง _schema_ เท่านั้นที่จะถูกโหลด เมื่อลาก _visual_ เข้ามา ระบบจะส่ง _query_ ไปยังแหล่งข้อมูลเพื่อดึงข้อมูลมาแสดง ระยะเวลาในการโหลดขึ้นอยู่กับประสิทธิภาพของแหล่งข้อมูล
- หากข้อมูลต้นทางมีการเปลี่ยนแปลง _visuals_ ที่มีอยู่จะไม่แสดงผลลัพธ์ใหม่ทันที เพราะมีการใช้ _caching_ จำเป็นต้อง _refresh_ เพื่อดูการเปลี่ยนแปลง
- เมื่อเผยแพร่ไฟล์ไปยัง _Power BI service_ จะเผยแพร่เฉพาะ _semantic model_ โดยไม่มีข้อมูลรวมอยู่ด้วย
- เมื่อเปิดรายงานบน _Power BI service_ ระบบจะส่ง _queries_ ไปยังแหล่งข้อมูลต้นทางอีกครั้ง หากแหล่งข้อมูลอยู่ภายในองค์กร อาจต้องใช้ _on-premises data gateway_
- สามารถปักหมุด (_pin_) _visual_ หรือหน้ารายงานลงบน _dashboard tiles_ ได้ โดย _tiles_ จะ _refresh_ อัตโนมัติตามกำหนดเวลา เช่น ทุก 1 ชั่วโมง และสามารถกำหนดความถี่ได้เอง เมื่อเปิด _dashboard_ จะแสดงข้อมูลจากครั้งล่าสุดที่ _refresh_ ซึ่งอาจไม่ใช่ข้อมูลล่าสุด จนกว่าจะ _refresh_ ด้วยตนเอง

### Limitations of DirectQuery connections

ข้อจำกัดของการใช้ _DirectQuery_ มีดังนี้:

- **Performance** - ขึ้นอยู่กับประสิทธิภาพของแหล่งข้อมูล
- **Security** - หากมีการเชื่อมต่อหลายแหล่งข้อมูล ต้องพิจารณาการไหลของข้อมูลและผลกระทบด้านความปลอดภัย รวมถึงสิทธิ์ในการเข้าถึงข้อมูลของผู้ใช้แต่ละคน
- **Data transformation** - การแปลงข้อมูลมีข้อจำกัดมาก เช่น หากเชื่อมต่อ _OLAP source_ เช่น _SAP BW_ จะไม่สามารถแปลงข้อมูลได้เลย ต้องแปลงจากฝั่งแหล่งข้อมูลเท่านั้น
- **Modeling** - ความสามารถบางอย่างที่มีใน _imported data_ อาจใช้ไม่ได้หรือใช้ได้จำกัด
- **Reporting** - ความสามารถในการรายงานเกือบทั้งหมดที่มีใน _imported data_ จะยังสามารถใช้ได้ ถ้าแหล่งข้อมูลมีประสิทธิภาพเพียงพอ

ดูรายละเอียดเพิ่มเติมได้ที่ [Implications of using DirectQuery](https://learn.microsoft.com/en-us/power-bi/connect-data/desktop-directquery-about/#implications-of-using-directquery)

## Optimize performance

ในสถานการณ์ของ _Tailwind Traders_ หลังจากตรวจสอบพบว่า _semantic model_ ใช้ _DirectQuery_ ซึ่งเป็นสาเหตุที่ทำให้รายงานโหลดช้า และตารางไม่ _refresh_ ได้เร็ว คุณต้องดำเนินการปรับปรุงประสิทธิภาพ

คุณสามารถตรวจสอบ _queries_ ที่ส่งไปยังแหล่งข้อมูลเพื่อระบุว่าเกิดความล่าช้าในส่วนใด และทำการปรับแต่งใน _Power BI Desktop_ หรือที่แหล่งข้อมูลได้

### Optimize data in Power BI Desktop

เมื่อปรับแต่งแหล่งข้อมูลเรียบร้อยแล้ว คุณสามารถใช้ **Performance Analyzer** ใน _Power BI Desktop_ เพื่อตรวจสอบและแยก _query_ เพื่อดูแผนการทำงาน (_query plan_)

สามารถวิเคราะห์ระยะเวลาของ _query_ แต่ละรายการ เพื่อระบุจุดที่เป็น _bottleneck_

คุณไม่จำเป็นต้องใช้เทคนิคพิเศษในการปรับแต่ง _DirectQuery model_ สามารถใช้แนวทางเดียวกับที่ใช้กับ _imported data_ เช่น ลดจำนวน _visuals_ ต่อหน้า หรือลดจำนวน _fields_ ที่ใช้ใน _visual_ รวมถึงลบคอลัมน์หรือแถวที่ไม่จำเป็น

ดูคำแนะนำเพิ่มเติมที่ [DirectQuery model guidance in Power BI Desktop](https://learn.microsoft.com/en-us/power-bi/guidance/directquery-model-guidance/) และ [Guidance for using DirectQuery successfully](https://learn.microsoft.com/en-us/power-bi/connect-data/desktop-directquery-about#guidance-for-using-directquery-successfully/?azure-portal=true)

### Optimize the underlying data source (connected database)

ขั้นแรกควรปรับแต่งที่แหล่งข้อมูลต้นทาง เพราะการปรับปรุงที่นั่นจะส่งผลโดยตรงกับประสิทธิภาพของ _DirectQuery_

แนวทางมาตรฐานที่แนะนำได้แก่:

- หลีกเลี่ยงการใช้ _calculated columns_ ที่ซับซ้อน เพราะจะทำให้ _expression_ ถูกรวมเข้าไปใน _query_ ที่ส่งไปยังแหล่งข้อมูล ควรผลักภาระไปยังแหล่งข้อมูลโดยตรง หรือใช้ _surrogate key_ ในตารางมิติ
- ตรวจสอบ _index_ ของตาราง และปรับปรุงให้เหมาะสม หากต้องสร้างใหม่ ควรมั่นใจว่าเหมาะกับรูปแบบการใช้งาน

ดูคำแนะนำเฉพาะของแต่ละแหล่งข้อมูลเพื่อปรับแต่งให้ดีที่สุด

### Customize the Query reduction options

_Power BI Desktop_ มีตัวเลือกในการลดจำนวน _queries_ และปิดใช้งาน _interactions_ บางอย่างเพื่อหลีกเลี่ยงประสบการณ์ที่แย่จาก _queries_ ที่ทำงานช้า

คุณสามารถเข้าไปที่ **File > Options and settings > Options** แล้วเลือก **Query reduction** เพื่อเปิดใช้งานตัวเลือกต่าง ๆ ดังนี้:

- **Reduce number of queries sent by** - ปิดการโต้ตอบระหว่าง _visuals_ ทุกตัว แล้วไปเลือกเองทีหลังด้วย **Edit interactions**
- **Slicers** - แทนการ _apply_ ทันที สามารถเพิ่มปุ่ม **Apply** ให้ผู้ใช้กดเองได้
- **Filters** - แทนการ _apply_ ทันที สามารถเลือกให้มี:
  - ปุ่ม Apply ให้กับทุก _basic filters_
  - ปุ่ม Apply เดียวใน _filter pane_ เพื่อ _apply_ พร้อมกัน (preview)

[![Screenshot shows access query reduction settings.](https://learn.microsoft.com/en-us/training/modules/optimize-model-power-bi/media/5-query-reduction-settings-ssm.png)](https://learn.microsoft.com/en-us/training/modules/optimize-model-power-bi/media/5-query-reduction-settings-ssm.png#lightbox#lightbox)
